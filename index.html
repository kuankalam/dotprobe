<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>DotProbe_FaceAnxiety_PIX</title>
    <!-- 引入jsPsych 6.3.1核心库和插件 -->
    <script src="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/jspsych.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/plugins/jspsych-html-button-response.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/plugins/jspsych-instructions.js"></script>
    <style>
        /* 实验页面样式：黑底白字，全屏 */
        body { margin: 0; padding: 0; background-color: black; color: white; font-family: "Heiti SC", "PingFang SC", "Microsoft YaHei", sans-serif; }
        .jspsych-display-element { width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        /* 词对容器：左右间距300px（对应原x_offset=150px，总宽度300px） */
        .word-pair { display: flex; justify-content: space-between; width: 300px; }
        .word { font-size: 40px; color: white; }
        /* 注视点、箭头、反馈样式 */
        .fixation { font-size: 50px; color: white; }
        .probe { font-size: 50px; color: white; }
        .feedback { font-size: 40px; color: white; }
        /* 被试信息录入表单样式 */
        #subject-info { display: flex; flex-direction: column; gap: 15px; font-size: 20px; padding: 20px; }
        #subject-info input, #subject-info select { padding: 8px; font-size: 18px; width: 200px; }
        #subject-info button { padding: 10px 20px; font-size: 18px; cursor: pointer; }
        /* 全屏提示样式 */
        .fullscreen-tip { font-size: 26px; text-align: center; padding: 20px; }
        /* 全屏状态提示 */
        .fullscreen-status { position: fixed; top: 10px; right: 10px; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 5px; font-size: 14px; }
    </style>
</head>
<body>
    <div id="jspsych-target"></div>

    <script>
        // ======================
        // 1. 全局参数配置
        // ======================
        let expInfo = { participant: '', gender: '', age: '' };
        const left_key = 's';
        const right_key = 'k';
        const timings = {
            fix1_dur: 0.3,    // 第一次注视点
            word_dur: 0.6,    // 词对呈现
            fix2_dur: 0.3,    // 第二次注视点
            probe_vis_dur: 2.0,// 箭头视觉呈现
            max_rt: 2.0,      // 最大反应时窗口
            fb_dur: 1.0,      // 反馈呈现
            iti_dur: 0.5      // 试次间隔
        };
        const word_pairs = [
            ['肥胖', '书桌'],['痘印', '路灯'],['皱纹', '杯子'],['脱发', '雨伞'],['色斑', '按钮'],
            ['眼袋', '台阶'],['塌鼻', '胶带'],['浮肿', '花盆'],['赘肉', '时钟'],['毛孔', '抽屉'],
            ['颈纹', '钢笔'],['泪沟', '钥匙'],['黑头', '信封'],['暗沉', '橡皮'],['粗腰', '托盘'],
            ['头屑', '书签'],['泛红', '日历'],['腿毛', '水瓶'],['黄牙', '剪刀'],['疤痕', '耳机']
        ];

        // ======================
        // 2. 全屏功能封装（修复版）
        // ======================
        function enterFullscreen() {
            const elem = document.documentElement;
            
            // 显示全屏状态
            showFullscreenStatus();
            
            // 处理不同浏览器的全屏API兼容
            const requestFullscreen = elem.requestFullscreen || 
                                    elem.mozRequestFullScreen || 
                                    elem.webkitRequestFullscreen || 
                                    elem.msRequestFullscreen;
            
            if (requestFullscreen) {
                requestFullscreen.call(elem).catch(err => {
                    console.log('全屏请求失败:', err);
                    alert('自动全屏失败，请按F11键手动进入全屏模式后继续实验！');
                });
            } else {
                alert('您的浏览器不支持自动全屏，请按F11键手动进入全屏模式后继续实验！');
            }

            // 监听全屏退出事件，提示被试重新进入
            document.addEventListener('fullscreenchange', checkFullscreen);
            document.addEventListener('webkitfullscreenchange', checkFullscreen);
            document.addEventListener('mozfullscreenchange', checkFullscreen);
            document.addEventListener('MSFullscreenChange', checkFullscreen);
        }

        function checkFullscreen() {
            const isFullscreen = document.fullscreenElement || 
                               document.webkitFullscreenElement || 
                               document.mozFullScreenElement || 
                               document.msFullscreenElement;
            
            if (!isFullscreen) {
                alert('实验需要在全屏模式下进行，请按F11重新进入全屏后继续！');
                enterFullscreen(); // 自动重新尝试进入全屏
            }
            showFullscreenStatus();
        }

        function showFullscreenStatus() {
            let statusEl = document.querySelector('.fullscreen-status');
            if (!statusEl) {
                statusEl = document.createElement('div');
                statusEl.className = 'fullscreen-status';
                document.body.appendChild(statusEl);
            }
            
            const isFullscreen = document.fullscreenElement || 
                               document.webkitFullscreenElement || 
                               document.mozFullScreenElement || 
                               document.msFullscreenElement;
            
            statusEl.textContent = isFullscreen ? '全屏模式 ✓' : '非全屏模式 ✗';
        }

        // ======================
        // 3. 生成实验试次条件表
        // ======================
        function generateTrials() {
            let trials = [];
            word_pairs.forEach(([negWord, neuWord]) => {
                [ 'left', 'right' ].forEach(negSide => {
                    [ 'left', 'right' ].forEach(arrowSide => {
                        const arrowDir = Math.random() > 0.5 ? 'left' : 'right';
                        const arrowText = arrowDir === 'left' ? '←' : '→';
                        const correctKey = arrowDir === 'left' ? left_key : right_key;
                        let leftWord, rightWord;
                        if (negSide === 'left') {
                            leftWord = negWord;
                            rightWord = neuWord;
                        } else {
                            leftWord = neuWord;
                            rightWord = negWord;
                        }
                        const trialType = negSide === arrowSide ? 'congruent' : 'incongruent';
                        trials.push({
                            negWord, neuWord, negSide, arrowSide, arrowDir, arrowText,
                            correctKey, leftWord, rightWord, trialType
                        });
                    });
                });
            });
            return jsPsych.randomization.shuffle(trials);
        }

        // ======================
        // 4. 被试信息录入界面（修复：提交后进入全屏）
        // ======================
        function createSubjectInfoScreen() {
            const html = `
                <div id="subject-info">
                    <h2>实验被试信息录入</h2>
                    <div class="fullscreen-tip">
                        <p>实验需要全屏模式，填写信息后会自动进入全屏。</p>
                        <p>如果全屏失败，请按F11键手动进入全屏。</p>
                    </div>
                    <div>
                        <label>被试编号：</label>
                        <input type="text" id="participant" required placeholder="请输入编号">
                    </div>
                    <div>
                        <label>性别：</label>
                        <select id="gender" required>
                            <option value="">请选择</option>
                            <option value="f">女</option>
                            <option value="m">男</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    <div>
                        <label>年龄：</label>
                        <input type="number" id="age" required placeholder="请输入年龄">
                    </div>
                    <button id="start-btn">开始实验</button>
                </div>
            `;
            return {
                type: 'html-button-response',
                stimulus: html,
                choices: [],
                on_load: function() {
                    document.getElementById('start-btn').addEventListener('click', function() {
                        expInfo.participant = document.getElementById('participant').value;
                        expInfo.gender = document.getElementById('gender').value;
                        expInfo.age = document.getElementById('age').value;
                        if (!expInfo.participant || !expInfo.gender || !expInfo.age) {
                            alert('请完整填写被试信息！');
                            return;
                        }
                        // 提交信息后立即进入全屏
                        enterFullscreen();
                        jsPsych.finishTrial();
                    });
                }
            };
        }

        // ======================
        // 5. 实验指导语界面（修复：空格键触发问题）
        // ======================
        const instructionScreen = {
            type: 'html-keyboard-response',
            stimulus: `
                <div style="width: 800px; font-size: 26px; line-height: 1.8;">
                    <h2>欢迎参加实验！</h2>
                    <p>本实验的流程如下，请你认真阅读并且遵守以下规则：</p>
                    <ol>
                        <li>屏幕中央先出现"+"，整个实验过程中你应该注视它；</li>
                        <li>接着左右同时出现两个词语；</li>
                        <li>词语消失后，其中一个位置会出现白色箭头"←"或"→"；</li>
                        <li>你的任务：主任务：尽快按对应的按键；<br>
                                    次任务：尽可能地记忆更多的词语。<br>
                            - 箭头朝左 ← 按 "S" 键<br>
                            - 箭头朝右 → 按 "K" 键</li>
                        <li>请尽量回答得又快又准！每次作答会提供反馈。</li>
                        </li>如果按错，下一试次请尽量保证正确率，正确率达60%以上可获得额外奖金；</li>
                        <li>一轮 80 次，约 5 分钟，中途可眨眼，但请勿说话；</li>
                        <li>实验过程中如有不适，可随时停止实验。</li>
                    </ol>
                    <p style="color: #4CAF50; font-weight: bold;">明白后，请按下"空格"键开始。</p>
                </div>
            `,
            choices: [' '], // 修复：使用空格字符而不是'space'
            response_ends_trial: true,
            on_load: function() {
                // 确保指导语页面也在全屏模式
                showFullscreenStatus();
            }
        };

        // ======================
        // 6. 构建单个实验试次流程
        // ======================
        function buildTrial(trialData) {
            const trialSequence = [];
            // 第一次注视点（+）
            trialSequence.push({
                type: 'html-keyboard-response',
                stimulus: '<div class="fixation">+</div>',
                trial_duration: timings.fix1_dur * 1000,
                response_ends_trial: false,
                data: { phase: 'fix1' }
            });
            // 词对呈现
            trialSequence.push({
                type: 'html-keyboard-response',
                stimulus: `
                    <div class="word-pair">
                        <div class="word">${trialData.leftWord}</div>
                        <div class="word">${trialData.rightWord}</div>
                    </div>
                `,
                trial_duration: timings.word_dur * 1000,
                response_ends_trial: false,
                data: { phase: 'word_pair', ...trialData }
            });
            // 第二次注视点（+）
            trialSequence.push({
                type: 'html-keyboard-response',
                stimulus: '<div class="fixation">+</div>',
                trial_duration: timings.fix2_dur * 1000,
                response_ends_trial: false,
                data: { phase: 'fix2' }
            });
            // 探针（箭头）呈现与反应收集
            trialSequence.push({
                type: 'html-keyboard-response',
                stimulus: () => {
                    const arrowPosStyle = trialData.arrowSide === 'left' 
                        ? 'position: relative; right: 150px;' 
                        : 'position: relative; left: 150px;';
                    return `<div class="probe" style="${arrowPosStyle}">${trialData.arrowText}</div>`;
                },
                choices: [left_key, right_key],
                trial_duration: timings.max_rt * 1000,
                data: { phase: 'probe', ...trialData },
                on_finish: function(data) {
                    if (data.rt === null) {
                        data.correct = 0;
                        data.feedback = '超时未作答！';
                    } else {
                        data.correct = data.response === data.correctKey ? 1 : 0;
                        data.feedback = data.correct ? '回答正确！' : '回答错误！';
                    }
                }
            });
            // 反馈呈现
            trialSequence.push({
                type: 'html-keyboard-response',
                stimulus: function() {
                    const lastData = jsPsych.data.get().last(1).values()[0];
                    return `<div class="feedback">${lastData.feedback}</div>`;
                },
                trial_duration: timings.fb_dur * 1000,
                response_ends_trial: false,
                data: { phase: 'feedback' }
            });
            // 试次间隔（ITI）
            trialSequence.push({
                type: 'html-keyboard-response',
                stimulus: '',
                trial_duration: timings.iti_dur * 1000,
                response_ends_trial: false,
                data: { phase: 'iti' }
            });
            return trialSequence;
        }

        // ======================
        // 7. 实验结束界面
        // ======================
        const endScreen = {
            type: 'html-keyboard-response',
            stimulus: `
                <div style="font-size: 32px; text-align: center;">
                    <p>实验结束，感谢参与！</p>
                    <p>数据已自动下载，可按Esc键退出全屏并关闭页面。</p>
                </div>
            `,
            choices: jsPsych.NO_KEYS,
            trial_duration: 8000
        };

        // ======================
        // 8. 数据自动下载功能
        // ======================
        function downloadData(data, expInfo) {
            const trialData = jsPsych.data.get().filter({ phase: 'probe' }).values();
            const formattedData = trialData.map(d => ({
                participant: expInfo.participant,
                gender: expInfo.gender,
                age: expInfo.age,
                negWord: d.negWord,
                neuWord: d.neuWord,
                negSide: d.negSide,
                arrowSide: d.arrowSide,
                arrowDir: d.arrowDir,
                trialType: d.trialType,
                response: d.response,
                correctKey: d.correctKey,
                correct: d.correct,
                rt: d.rt ? d.rt.toFixed(3) : null,
                feedback: d.feedback
            }));
            const headers = Object.keys(formattedData[0]).join(',');
            const rows = formattedData.map(row => Object.values(row).join(','));
            const csv = [headers, ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            link.setAttribute('download', `DotProbe_FaceAnxiety_PIX_${expInfo.participant}_${expInfo.gender}_${expInfo.age}_${timestamp}.csv`);
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // ======================
        // 9. 组装并运行实验流程
        // ======================
        function runExperiment() {
            const timeline = [];
            timeline.push(createSubjectInfoScreen());
            timeline.push(instructionScreen);
            const allTrials = generateTrials();
            allTrials.forEach(trial => {
                timeline.push(...buildTrial(trial));
            });
            timeline.push(endScreen);

            jsPsych.init({
                display_element: 'jspsych-target',
                timeline: timeline,
                on_finish: function() {
                    downloadData(jsPsych.data.get(), expInfo);
                }
            });
        }

        // 启动实验
        runExperiment();
    </script>
</body>
</html>